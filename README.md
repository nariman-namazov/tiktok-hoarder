# tiktok-hoarder
Програма для завантаження відео в ТікТоці і їх послідовної відправки у Телеграм-канал чи особисті повідомлення.

## Особливості
- Можна запускати як на Лямбді, так і на своєму комп'ютері, але в другому випадку доведеться зробити деякі зміни.
- Тягне 8 відео кожен раз що скрипт запущено.
- Підтримує мультипотоковість.
- Не потребує ALB чи будь-чого іншого перед лямбдою чи машиною, яка запускає скрипт. Достатньо однієї лінії в cron.
- Не підтримує Windows.
- Підтримує геолок.
- Всі логи (за умови використання шаблону CloudFormation) видаляються через день.

## Вимоги до старта
- boto3 і requests
- Печивки з ТікТока, при цьому мають бути у форматі, який генерує Файрфокс (принаймні `http.cookiejar` викликає `MozillaCookieJar()`). Має сенс встановити cookies.txt з базару додатків браузера.
- Бот у Телеграмі.
- Наявність [yt-dlp](https://github.com/yt-dlp/yt-dlp) та [ffmpeg](https://ffbinaries.com/downloads) також обов'язкова. Інколи останній може просто не працювати без будь-якої помилки. Щоб цього позбавитися, треба завантажити бінар ffmpeg саме з того сайта.

Ось такий розміщений у тій самій теці що й lambda_function.py `yt-dlp.conf`. Фейсбучний юзер-агент потрібен для того, щоб ТікТок надто сильно не гавкав:
```
--user-agent facebookexternalhit/1.1
--force-ipv4
--no-geo-bypass
-o /tmp/%(uploader)s-%(id)s.mp4
```

### Розробка без лямбди
Скрипт розраховує, що у середовищних змінних (environment variables) проставлені наступні значення:
- chat_id => куди відправляти всі відео
- bucket => "local_storage:<абсолютний чи відносний шлях до файла з кукіз>"; у лямбді це ім'я S3 відра
- token => токен бота у Телеграмі без "bot"
- feedback => chat_id діалога чи канала, куди мають йти повідомлення, якщо не вдалося завантажити відео; якщо не хочеш нікуди відправляти, став значення "/dev/null"
- geolock => регіон двозначним кодом ISO-3166 з якого мають надходити усі відео у фіді акаунта

У кінці `lambda_function.py` доведеться додати наступний код:
```python
lambda_handler("te", "te")
```

### Розробка з лямбдою
Код лямбди доведеться оновлювати руками, шаблон CloudFormation створить лямбду із мінімально заповненим файлом `main.py` тільки щоб уникнути помилки.

Архів слід формувати наступним чином:
```bash
$ tree tiktok-hoarder
 |-ffmpeg
 |-lambda_function.py
 |-package
 | |-<your libraries installed via `pip install --target ./tiktok-hoarder/package requests`>
 |-yt-dlp
 |-yt-dlp.conf

$ rm -f package.zip && cd package && zip -qr ../package.zip . && cd ../ && zip package.zip ffmpeg lambda_function.py yt-dlp yt-dlp.conf
```

**ACHTUNG!** Станом на червень 2023 залежності слід обов'язково встановлювати так, щоб urllib3 був нижче версії 2 (просто додай `"urllib3<2"` до pip команди вище).

## Як програма працює
Алгоритм роботи:
1. Тягне файл з cookies для ТікТока. Обліковий запис може бути будь-яким іншим, головне щоб були печивки з браузера.
2. Відправляє запит ТікТоку і просить показати список відео з фіда.
3. У циклі йде крізь кожне відео у списку та генерує посилання.
4. У кількох потоках запускає yt-dlp та завантажує кожне відео.
5. Стоврює обгортку для кожного відео, а також підтягує його довжину та розмір у пікселях.
6. Відправляє відео у канал в Телеграмі чи особисті повідомлення якогось користувача.
7. За умови, що відео неможливо завантажити у Телеграм через його розмір (для ботів обмеження становить 50 МБ), сповіщення про це відправляється куди прописано в налаштуваннях. За будь-якої іншої проблеми також.

З допомогою плагіна для ТікТока на Андроїда, який - окрім кількох інших речей - уміє геозамикатися на конкретний регіон, було [з'ясовано](https://github.com/tigr1234566/TikTokMod/blob/master/smali/com/ss/android/ugc/aweme/net/i/a.smali), що безпосередньо додаток тягне відео для фіда з наступних куточків:
- api-va.tiktokv.com
- api16-va.tiktokv.com
- api19-va.tiktokv.com
- api-h2.tiktokv.com

Яка між ними різниця достеменно невідомо, ще гіршим є те, що вочевидь будь-який домен з `api` у назві видаватиме відео. Залежно від прокинутих параметрів змінюється багато чого. Наприклад, за умови, що під час виклику `/aweme/v1/feed/` надається параметр `type=0`, китайці відповідатимуть нісенітницею (хоча й не без того, що в акаунта в інтересах), а от `type=1` змусить показувати фід з телефона із вкладки Following, тож з точки зору доречності контенту стане трохи легше.

За час довбання головою об стіну було знайдено, що найоптимальнішим буде відправляти наступні параметри в бік `api19-va.tiktokv.com`: `type=0&app_name=trill&min_cursor=-1&max_cursor=0&region={GEOLOCK}`. GEOLOCK - це код країни, звісно ж. Зміна чи позбавлення від деяких з них не призведе ні до чого (ТікТок видаватиме все те саме), за якою саме системою вони працюють науці досі невідомо.

Окрім безпосередньо геолока під час виклику ТікТока доведеться погратися в акаунті та повідмічати нецікаві відео (довгий тап => Not interested чи щось таке), ну а ще прямо в скрипті обмазатися підхопленням відео виключно з країни в геолоці.

До речі, інколи ТікТок викидає 4 або 3 посилання на відео за запуск лямбди, інколи це значення росте до від 6 до 16. З `type=1` він відправлятиме одні й ті самі відео у фіді з якоїсь причини, проте це буде не в 100% запусків лямбди.

## Пост-скриптум для загального розвитку
### Як ТікТок аутентифікує користувача у Веб-версії
Ось цей ендпоїнт (залежно від регіону він інший) відповідальний за аутентифікацію користувача. Вимагає email та password у, судячи з нутрощів вкладки Network у браузері, невідомому мені хешованому форматі, але окрім цього генерує(?) ще [sid_tt](https://github.com/lucasintel/tiktok-passport).
```
https://www-useast1a.tiktok.com/passport/web/user/login/
```

Публічної документації не існує, а реверс за допомогою [HTTP toolkit](https://httptoolkit.com/) чи будь-якого іншого Вайршарка не дає нічого значущого, бо весь трафік зашифрований, а сервера не приймають самопальні сертифікати. Остання опція - Frida (японці у своїй частині Інтернета мають гайди на тему реверса ТікТока) чи подібна програма, але в мене руки не дійшли.

Біла людина з Австралії [реверснула](https://medium.com/@szdc/reverse-engineering-the-musical-ly-api-662331008eb3) API додатка і створила обгортку довкола програми: https://github.com/szdc/tiktok-api. На основі кода доходимо висновку, що аутентифікація робиться плюс-мінус ось так:
```python
import requests

def encrypt_data(string):
    key = 5; encrypted = ""
    # https://stackoverflow.com/questions/7291120/get-unicode-code-point-of-a-character-using-python
    for c in string:
        character = ord(c) ^ key; encrypted += str(hex(character)).split("0x")[1]

    return encrypted

payload = {
    "mix_mode": 1,
    "email": encrypt_data(<електронна пошта акаунта>),
    "password": encrypt_data(<пароль>)
}
res = requests.post("https://www.tiktok.com/passport/user/login/", params=payload, headers={"Content-Type": "application/json"})
print (res.content)
```
Швидше за все ця вузькоока шляпа викине у відповідь щось там про maximum attempts tried, але це просто захист від ботів, який все ж має якось обходитися, враховуюч що використання печивок без зайвих маніпуляцій з юзер-агентом чи подібних речей дає результати. Якщо комусь **дуже** треба вміти логінитися без танців з ~~бубном~~ cookies, є варіант [придбати](https://github.com/MrsZ/TikTok-Login) робочий код за 900 євро.

### Де ТікТок береже відео без вотермарок
Його ж використовує yt-dlp для завантаження відео без вотермарок; варто додати, що будь-який `apiXY-normal-c` сервер містить у собі відео без них.
```
https://api16-normal-c-useast1a.tiktokv.com
```

### Конфіг ТікТока
Додаткові цікавинки можна подивитися [тут](https://www.diffchecker.com/nwuQhTQq/) (копії оригінала і нового файлів додані до теки readme, а сторінку [заархівовано](https://archive.is/LcG9m)), вочевидь один з розробників випадково закинув у публічний доступ дві версії конфіга ТікТока.

Пошук у Гуглі деяких з доменів веде також [сюди](https://gist.github.com/rastreador/b9ebc897f65eaaaf1e388396c8561e2d).

### Стягування усіх відео конкретного користувача
Наступний шмат кода стягне список усіх відео конкретного користувача. Не потребує аутентифікації за умови, що користувач не запривачений.
```python
res = requests.get("https://www.tiktok.com/@qnesko007", headers={"Content-Type": "application/json"})
output = res.content.decode()
output = output.replace('<script id="SIGI_STATE"', '\n<script id="SIGI_STATE"'); output = output.replace('</script>', '\n</script>')
for line in output.split("\n"):
    if "SIGI_STATE" in line:
        target = line
        break
target = target.replace('<script id="SIGI_STATE" type="application/json">', ""); target = target.replace('</script>', "")
for item in json.loads(target):
    print (item)
target = json.loads(target)
print (target["ItemList"]["user-post"]["list"])
```
